<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
  <title>Market Brief ‚Äî XRayCrypto News</title>
  <link rel="icon" type="image/png" href="pfp.png" sizes="32x32"/>
  <link rel="stylesheet" href="styles.css"/>
</head>

<body>
  <!-- HEADER -->
  <header class="header">
    <div class="topbar container">
      <a class="brand" href="index.html" data-softnav>
        <img src="pfp.png" alt="XRayCrypto logo" class="logo"/>
        <span class="name">XRayCrypto<span class="tm" aria-hidden="true">‚Ñ¢</span></span>
      </a>

      <button id="menuToggle" class="hamburger" aria-label="Open menu" aria-expanded="false" aria-controls="primaryNav">‚ò∞</button>

      <nav id="primaryNav" class="nav">
        <a href="marketbrief.html" class="active" data-softnav>MarketBrief</a>
        <a href="index.html" data-softnav>Crypto</a>
        <a href="markets.html" data-softnav>Markets</a>
        <a href="watchlist.html" data-softnav>Watchlist</a>
        <a href="news.html" data-softnav>News</a>
        <a href="store.html" data-softnav>Store</a>
        <a href="chill.html" data-softnav>ChillZone</a>
        <a href="support.html" data-softnav>Support</a>
      </nav>

      <div id="headerControls" class="symbol-form">
        <button id="themeToggle" class="button outline" type="button" title="Toggle theme">üåô</button>
      </div>
    </div>

    <!-- Tickers -->
    <div class="ticker"><div id="cryptoTape"></div></div>
    <div class="ticker"><div id="stocksTape"></div></div>
  </header>

  <!-- MAIN -->
  <main class="main container" id="pageMain">
    <section class="section">
      <h1>Market Brief</h1>
      <div id="brief-content" data-latest-brief>Loading latest brief‚Ä¶</div>
      <noscript><p>Please enable JavaScript to view the latest brief.</p></noscript>
    </section>
  </main>

  <!-- FOOTER -->
  <footer class="footer">
   <button id="ambientToggle" class="button outline" type="button" title="Toggle ambient glow">‚ú®</button> 
    ¬© 2025 XRayCrypto‚Ñ¢ ¬∑
    <a href="https://x.com/xraycryptox" target="_blank" class="x-link">X</a>
    <a href="support.html" class="support-cta" data-softnav>‚ù§ Support XR</a>
  </footer>

  <!-- Worker base: point to the ROOT (not /fetch) -->
  <script id="news-config" type="application/json">
  { "workerBase": "https://xraycrypto-news.xrprat.workers.dev/" }
  </script>

  <script>
  (async () => {
    const cfgEl = document.getElementById('news-config');
    const base = cfgEl ? (JSON.parse(cfgEl.textContent).workerBase || "/") : "/";
    const el = document.getElementById('brief-content');

    const safe = s => String(s ?? "").replace(/[&<>"']/g, m => (
      {"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m]
    ));

    try {
      // 1) Get feed JSON to find the latest slug
      const feedRes = await fetch(base + "marketbrief/feed/index.json", { cache: "no-store" });
      if (!feedRes.ok) throw new Error("feed fetch failed");
      const feed = await feedRes.json();

      if (!feed?.latest) {
        el.textContent = "No brief yet. Check back soon.";
        return;
      }

      // 2) Fetch that brief's JSON
      const briefRes = await fetch(base + `marketbrief/briefs/${feed.latest}.json`, { cache: "no-store" });
      if (!briefRes.ok) throw new Error("brief fetch failed");
      const b = await briefRes.json();

      const sources = Array.isArray(b.sources) && b.sources.length
        ? `<details><summary>Sources</summary><ul>${
            b.sources.map(s =>
              `<li><a href="${s.url}" target="_blank" rel="noopener">${safe(s.label || s.url)}</a></li>`
            ).join("")
          }</ul></details>`
        : "";

      el.innerHTML = `
        <article class="brief">
          <h2>${safe(b.title || ("Market Brief ‚Äî " + (b.date || "")))}</h2>
          <p class="muted">${safe(b.date || "")}</p>
          ${b.article_html || ""}
          ${b.last_word ? `<hr><p><em>${safe(b.last_word)}</em></p>` : ""}
          ${sources}
          <p class="muted" style="margin-top:12px">
            <a href="${base}marketbrief/${b.slug}" rel="noopener">Permalink</a>
          </p>
        </article>
      `;
    } catch (err) {
      console.error(err);
      // Fallback: link to Worker‚Äôs HTML permalink (served by /marketbrief/latest)
      el.innerHTML = `
        <p>Couldn‚Äôt load the JSON brief right now.</p>
        <p><a href="${base}marketbrief/latest" rel="noopener">Open the latest Market Brief</a></p>
      `;
    }
  })();
  </script>

  <script src="main.js"></script>
</body>
</html>
